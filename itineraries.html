<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Itineraries - Globeii</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- Main CSS -->
  <link rel="stylesheet" href="css/styles.css">

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
</head>

<body class="d-flex flex-column min-vh-100">

  <!-- HEADER -->
  <div id="header-placeholder"></div>

  <!-- MAIN CONTENT -->
  <main class="flex-fill itineraries-main container my-4" id="itinerariesContent" style="display:none;">
    <h2 class="mb-4 text-center">Itineraries</h2>

    <div class="itinerary-controls mb-3">
      <div class="d-flex gap-2">
        <button class="filter active" data-filter="active">Active</button>
        <button class="filter" data-filter="archived">Archived</button>
        <button class="filter" data-filter="all">All</button>
      </div>

      <div class="sort-wrapper">
        <button class="sort-btn" id="sortBtn">
          <i class="fa-solid fa-sort"></i> Sort
        </button>
        <div class="sort-menu" id="sortMenu">
          <button data-sort="name-asc">Name A–Z</button>
          <button data-sort="name-desc">Name Z–A</button>
          <button data-sort="date-asc">Date ↑</button>
          <button data-sort="date-desc">Date ↓</button>
        </div>
      </div>
    </div>

    <div id="list" class="d-flex flex-column gap-3"></div>
  </main>

  <!-- Add Button -->
  <button class="add-btn" id="addBtn">+</button>

  <!-- Add Itinerary Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="itinerary-modal" id="itineraryModal">
      <button class="modal-close" id="closeModalBtn">&times;</button>
      <h3>Add Itinerary</h3>
      <input id="nameInput" placeholder="Itinerary name" />
      <div class="modal-actions">
        <button class="btn btn-primary" id="addBtnModal">Add</button>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="footer-placeholder"></div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/layout.js"></script>
  <script src="js/header.js"></script>

  <script>
    window.layoutReady.then(async () => {
      const { data: { user } } = await supabaseClient.auth.getUser();

      if (!user) {
        window.location.href = 'login.html?redirectTo=itineraries.html';
        return;
      }

      document.getElementById('itinerariesContent').style.display = 'block';

      /* ===== STATE ===== */
      let filter = "active";
      let currentSort = null;

      const data = [
        { id: "1", name: "Paris Trip", dates: "2026-02-10", owned: true, places: 8, archived: false },
        { id: "2", name: "Tokyo Adventure", dates: "2026-03-05", owned: false, places: 6, archived: false },
        { id: "3", name: "NYC Weekend", dates: "2026-01-20", owned: true, places: 4, archived: true }
      ];

      const list = document.getElementById("list");

      /* ===== SORT ===== */
      function applySort() {
        if (!currentSort) return;

        data.sort((a, b) => {
          if (currentSort === "name-asc") return a.name.localeCompare(b.name);
          if (currentSort === "name-desc") return b.name.localeCompare(a.name);
          if (currentSort === "date-asc") return new Date(a.dates) - new Date(b.dates);
          if (currentSort === "date-desc") return new Date(b.dates) - new Date(a.dates);
        });
      }

      /* ===== RENDER ===== */
      function render() {
        applySort();
        list.innerHTML = "";

        data
          .filter(i => {
            if (filter === "all") return true;
            if (filter === "active") return !i.archived;
            return i.archived;
          })
          .forEach(i => {
            list.insertAdjacentHTML("beforeend", `
              <div class="itinerary-card d-flex align-items-center gap-3"
                   data-id="${i.id}"
                   role="button">
                
                <i class="fa-solid fa-location-dot card-icon"></i>

                <div class="flex-grow-1">
                  <div class="card-title">${i.name}</div>
                  <div class="card-dates">${i.dates}</div>

                  <div class="card-meta mt-1">
                    <span class="tag ${i.owned ? 'owned' : 'shared'}">
                      ${i.owned ? 'Owned' : 'Shared'}
                    </span>
                    <span class="tag">${i.places} places</span>
                  </div>
                </div>

                <i class="fa-solid fa-chevron-right card-chevron"></i>
              </div>
            `);
          });

        document.querySelectorAll(".itinerary-card").forEach(card => {
          card.onclick = () => {
            const id = card.dataset.id;
            window.location.href = `itinerary.html?id=${id}`;
          };
        });
      }

      /* ===== FILTERS ===== */
      document.querySelectorAll(".filter").forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll(".filter").forEach(x => x.classList.remove("active"));
          btn.classList.add("active");
          filter = btn.dataset.filter;
          render();
        };
      });

      /* ===== SORT MENU ===== */
      const sortBtn = document.getElementById("sortBtn");
      const sortMenu = document.getElementById("sortMenu");

      sortBtn.onclick = (e) => {
        e.stopPropagation();
        sortMenu.style.display = sortMenu.style.display === "block" ? "none" : "block";
      };

      document.querySelectorAll("#sortMenu button").forEach(btn => {
        btn.onclick = () => {
          currentSort = btn.dataset.sort;
          sortMenu.style.display = "none";
          render();
        };
      });

      document.addEventListener("click", () => {
        sortMenu.style.display = "none";
      });

      render();
    });

    const addBtn = document.getElementById("addBtn");
    const modalOverlay = document.getElementById("modalOverlay");
    const itineraryModal = document.getElementById("itineraryModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const addBtnModal = document.getElementById("addBtnModal");
    const nameInput = document.getElementById("nameInput");

    // Open modal
    addBtn.onclick = () => {
      modalOverlay.style.display = "block";
      setTimeout(() => {
        itineraryModal.classList.add("show");
        nameInput.focus();
      }, 10);
    };

    // Close modal function
    function closeModal() {
      itineraryModal.classList.remove("show");
      setTimeout(() => {
        modalOverlay.style.display = "none";
        nameInput.value = "";
      }, 300); // wait for slide down animation
    }

    // Close via top close button
    closeModalBtn.onclick = closeModal;

    // Close by clicking outside modal
    modalOverlay.onclick = (e) => {
      if (e.target === modalOverlay) closeModal();
    };

    // Validation & add logic
    function addItinerary() {
      const name = nameInput.value.trim();
      if (!name) {
        alert("Please type an itinerary name");
        nameInput.focus();
        return;
      }

      // Placeholder for Supabase logic
      alert(`Add itinerary logic goes here. Name: "${name}"`);
      closeModal();
    }

    // Add button click
    addBtnModal.onclick = addItinerary;

    // Enter key triggers add
    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        addItinerary();
      }
    });
    
  </script>
</body>
</html>