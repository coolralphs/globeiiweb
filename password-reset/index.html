<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signing you in...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- /supabase-config.js should set window.supabaseClient = supabase.createClient(...) -->
  <script src="/supabase-config.js"></script>
</head>
<body style="font-family:sans-serif;text-align:center;padding-top:40px;">
  <h2 id="msg">Signing you in securely...</h2>

<script>
(async () => {
  const statusEl = document.getElementById('status') || (function(){
    const el = document.createElement('div');
    el.id = 'status';
    el.style.padding = '1rem';
    el.style.fontFamily = 'system-ui, Arial';
    document.body.prepend(el);
    return el;
  })();

  function setStatus(msg, isError = false) {
    statusEl.textContent = msg;
    statusEl.style.color = isError ? 'crimson' : 'green';
    console.log(msg);
  }

  try {
    if (!supabaseClient) {
      setStatus('Supabase client not initialized (missing supabase-config).', true);
      return;
    }

    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    if (!code) {
      setStatus('No code param found in URL.', true);
      return;
    }

    setStatus('Exchanging code for session...');

    // Some SDK versions expect a plain string argument for exchangeCodeForSession
    if (typeof supabaseClient.auth.exchangeCodeForSession === 'function') {
      try {
        // Try calling with a plain string first
        const maybePromise = supabaseClient.auth.exchangeCodeForSession(code);
        // The method returns an object like { data, error } or may throw — await it
        const result = await maybePromise;
        // result may be { data, error } or { session, error } depending on SDK; normalize:
        const data = result?.data ?? result?.session ?? result;
        const error = result?.error ?? result?.error;
        if (error) {
          setStatus(`Exchange failed: ${error.message || JSON.stringify(error)}`, true);
          console.error('exchangeCodeForSession error', error);
          // fall through to fallback below
        } else {
          console.log('exchangeCodeForSession result', result);
          setStatus('Login successful — redirecting...');
          return setTimeout(() => window.location.href = '/', 700);
        }
      } catch (ex) {
        // If calling with plain string threw, try object form as fallback
        console.warn('exchangeCodeForSession(string) threw, trying object form', ex);
        try {
          const result2 = await supabaseClient.auth.exchangeCodeForSession({ code });
          if (result2?.error) {
            setStatus(`Exchange failed: ${result2.error.message || JSON.stringify(result2.error)}`, true);
            console.error('exchangeCodeForSession error', result2.error);
          } else {
            console.log('exchangeCodeForSession result2', result2);
            setStatus('Login successful — redirecting...');
            return setTimeout(() => window.location.href = '/', 700);
          }
        } catch (ex2) {
          console.error('exchangeCodeForSession fallback threw', ex2);
        }
      }
    }

    // Fallback: try verifyOtp (some projects use this)
    setStatus('Falling back to verifyOtp...');
    let result = await supabaseClient.auth.verifyOtp({ token_hash: code, type: 'magiclink' });
    if (result?.error) {
      result = await supabaseClient.auth.verifyOtp({ token: code, type: 'magiclink' });
    }

    if (result?.error) {
      setStatus(`Failed to verify code: ${result.error?.message || JSON.stringify(result.error)}`, true);
      console.error('verifyOtp error', result.error);
      return;
    }

    console.log('verifyOtp result', result);
    setStatus('Login successful — redirecting...');
    setTimeout(() => window.location.href = '/', 700);

  } catch (err) {
    console.error(err);
    setStatus('Unexpected error during verification. See console.', true);
  }
})();
</script>
</body>
</html>