<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signing you in...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- /supabase-config.js should set window.supabaseClient = supabase.createClient(...) -->
  <script src="/supabase-config.js"></script>
</head>
<body style="font-family:sans-serif;text-align:center;padding-top:40px;">
  <h2 id="msg">Signing you in securely...</h2>

<script>
(async () => {
  const statusEl = document.getElementById('status') || (function(){
    const el = document.createElement('div');
    el.id = 'status';
    el.style.padding = '1rem';
    el.style.fontFamily = 'system-ui, Arial';
    document.body.prepend(el);
    return el;
  })();

  function setStatus(msg, isError = false) {
    statusEl.textContent = msg;
    statusEl.style.color = isError ? 'crimson' : 'green';
    console.log(msg);
  }

  try {
    if (!window.supabaseClient) {
      setStatus('Supabase client not initialized (missing supabase-config).', true);
      return;
    }

    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    if (!code) {
      setStatus('No code param found in URL.', true);
      return;
    }

    setStatus('Exchanging code for session...');

    // Preferred: use exchangeCodeForSession if available (PKCE flow)
    if (typeof supabaseClient.auth.exchangeCodeForSession === 'function') {
      const { data, error } = await supabaseClient.auth.exchangeCodeForSession({ code });
      if (error) {
        setStatus(`Exchange failed: ${error.message}`, true);
        console.error('exchangeCodeForSession error', error);
        return;
      }
      console.log('exchangeCodeForSession result', data);
      setStatus('Login successful — redirecting...');
      return setTimeout(() => window.location.href = '/', 700);
    }

    // Fallback: some setups use verifyOtp with token_hash / token
    // Try verifyOtp with token_hash first, then with token
    let result = await supabaseClient.auth.verifyOtp({ token_hash: code, type: 'magiclink' });
    if (result.error) {
      // try using 'token' param if token_hash failed
      result = await supabaseClient.auth.verifyOtp({ token: code, type: 'magiclink' });
    }

    if (result.error) {
      setStatus(`Failed to verify code: ${result.error.message || JSON.stringify(result.error)}`, true);
      console.error('verifyOtp error', result.error);
      return;
    }

    console.log('verifyOtp result', result);
    setStatus('Login successful — redirecting...');
    setTimeout(() => window.location.href = '/', 700);

  } catch (err) {
    console.error(err);
    setStatus('Unexpected error during verification. See console.', true);
  }
})();
</script>
</body>
</html>