<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signing you in...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- /supabase-config.js should set window.supabaseClient = supabase.createClient(...) -->
  <script src="/supabase-config.js"></script>
</head>
<body style="font-family:sans-serif;text-align:center;padding-top:40px;">
  <h2 id="msg">Signing you in securely...</h2>

<script>
(async () => {
  // Change this if your client is available under a different global
  const supabase = supabaseClient;
  if (!supabase) {
    console.error('Supabase client not found on window.supabase or window.supabaseClient');
    return;
  }

  // 1) Read code from URL (query param or fragment)
  const url = new URL(window.location.href);
  let code = null;

  // Prefer query param ?code=...
  const q = url.searchParams.get('code');
  if (q) code = q;

  // If not in query, check fragment (#)
  if (!code && window.location.hash) {
    const hash = window.location.hash.replace(/^#/, '');
    const hashParams = new URLSearchParams(hash);
    // Some flows may put code in fragment as 'code' or include access_token
    code = hashParams.get('code') || hashParams.get('access_token') || null;
  }

  if (!code) {
    console.error('No authorization code or access_token found in URL (query or fragment).');
    return;
  }

  // 2) Ensure code is a plain string (defensive conversions)
  // If code somehow arrived as an object (rare in browser), convert to string
  if (typeof code !== 'string') {
    try {
      code = String(code);
    } catch (e) {
      console.error('Failed to convert code to string:', e);
      return;
    }
  }

  // Optional: Trim whitespace
  code = code.trim();

  // 3) Try exchangeCodeForSession (supabase-js v2) with code as a string
  try {
    console.log('Calling exchangeCodeForSession with code (string).');
    const result = await supabase.auth.exchangeCodeForSession(code);

    // Normalise the possible shapes
    const error = result?.error ?? result?.data?.error ?? null;
    const session = result?.data?.session ?? result?.session ?? result?.data ?? null;

    if (error) {
      console.warn('exchangeCodeForSession returned error:', error);
      // If error indicates missing code_verifier or invalid_grant, we'll try REST fallback below
    } else {
      console.log('Session result:', session);
      // Successfully exchanged â€” redirect or handle session
      window.location.href = '/';
      return;
    }
  } catch (ex) {
    console.warn('exchangeCodeForSession threw:', ex);
    // proceed to fallback
  }

  // 4) Fallback: try REST token endpoint if you have a stored PKCE code_verifier
  // You must have saved the code_verifier when you started the PKCE flow (e.g., sessionStorage)
  // Replace the storage key if your app uses a different one.
  const pkceKey = 'supabase.pkce.code_verifier';
  const codeVerifier = (() => {
    try {
      return sessionStorage.getItem(pkceKey) || localStorage.getItem(pkceKey) || null;
    } catch (e) {
      return null;
    }
  })();

  if (!codeVerifier) {
    console.error('No PKCE code_verifier found in sessionStorage/localStorage under key:', pkceKey);
    console.error('PKCE exchange cannot proceed without the original code_verifier. If you did not store it, you must restart the sign-in flow.');
    return;
  }

  // Build REST call body
  const projectUrl = (typeof SUPABASE_URL !== 'undefined') ? SUPABASE_URL : (supabase?.url || null);
  const anonKey = (typeof SUPABASE_ANON_KEY !== 'undefined') ? SUPABASE_ANON_KEY : (supabase?.anonKey || null);

  if (!projectUrl) {
    console.error('Cannot determine Supabase project URL. Ensure SUPABASE_URL or supabase client is available.');
    return;
  }

  // Remove trailing slash for safety
  const baseUrl = projectUrl.replace(/\/+$/, '');
  const tokenUrl = `${baseUrl}/auth/v1/token?grant_type=pkce`;

  // POST JSON to the /auth/v1/token endpoint
  try {
    const body = {
      code,
      client_id: anonKey,      // pass anon client id; if not available, server may still accept but best to provide it
      code_verifier: codeVerifier
    };

    console.log('Performing REST token exchange (PKCE) to /auth/v1/token');
    const resp = await fetch(tokenUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    const data = await resp.json();
    if (!resp.ok) {
      console.error('Token endpoint returned error:', data);
      return;
    }

    // data expected to contain access_token / refresh_token / expires_in etc.
    console.log('Token exchange successful:', data);

    // Optionally set the session in the client if you want:
    // supabase.auth.setSession is available in v2 to set session from server response
    if (typeof supabase.auth.setSession === 'function') {
      // Build the session object expected by setSession
      // setSession accepts { access_token, refresh_token } shape
      try {
        await supabase.auth.setSession({
          access_token: data.access_token,
          refresh_token: data.refresh_token
        });
        console.log('Session set in supabase client.');
        window.location.href = '/';
        return;
      } catch (e) {
        console.warn('Failed to set session on client, you may need to reload and handle tokens manually:', e);
      }
    } else {
      console.warn('supabase.auth.setSession not available on client; you may need to store tokens manually or perform server-side exchange.');
    }

  } catch (err) {
    console.error('REST token exchange failed:', err);
    return;
  }
})();
</script>
</body>
</html>