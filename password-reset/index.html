<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signing you in...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- /supabase-config.js should set window.supabaseClient = supabase.createClient(...) -->
  <script src="/supabase-config.js"></script>
</head>
<body style="font-family:sans-serif;text-align:center;padding-top:40px;">
  <h2 id="msg">Signing you in securely...</h2>

  <script>
  (async () => {
    // Minimal UI feedback (adjust DOM selectors as needed)
    const statusEl = document.getElementById('status') || (function(){
      const el = document.createElement('div');
      el.id = 'status';
      el.style.padding = '1rem';
      el.style.fontFamily = 'system-ui, Arial';
      document.body.prepend(el);
      return el;
    })();

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? 'crimson' : 'green';
    }

    try {
      if (!supabaseClient) {
        setStatus('Supabase client not initialized (missing supabase-config).', true);
        return;
      }

      // Read token from the query string
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token') || params.get('token_hash') || params.get('confirmation_url');

      if (!token) {
        setStatus('No token found in URL. Nothing to verify.', true);
        return;
      }

      setStatus('Exchanging magic link for session...');

      // Use verifyOtp to exchange the PKCE token for a session
      const { data, error } = await supabaseClient.auth.verifyOtp({
        token_hash: token,
        type: 'magiclink'
      });

      if (error) {
        // If the SDK expects 'token' instead of 'token_hash' you can retry below (uncomment if needed)
        // const retry = await window.supabaseClient.auth.verifyOtp({ token, type: 'magiclink' });

        setStatus(`Failed to verify magic link: ${error.message || JSON.stringify(error)}`, true);
        console.error('verifyOtp error', error);
        return;
      }

      // Success: session is returned in data.session for some SDK versions,
      // or data may contain the session structure depending on SDK implementation.
      console.log('verifyOtp result', data);
      setStatus('Login successful â€” redirecting...');

      // Optionally wait a short moment so any onAuthStateChange handlers run
      setTimeout(() => {
        // Redirect to home or any protected route
        window.location.href = '/';
      }, 700);

    } catch (err) {
      console.error(err);
      setStatus('Unexpected error during verification. See console for details.', true);
    }
  })();
  </script>
</body>
</html>